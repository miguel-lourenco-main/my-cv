image: node:18

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store

stages:
  - test
  - build
  - deploy

variables:
  NODE_ENV: production
  PNPM_CACHE_FOLDER: .pnpm-store

before_script:
  - corepack enable
  - corepack prepare pnpm@latest --activate
  - pnpm config set store-dir .pnpm-store
  - pnpm install --frozen-lockfile

# Detect and generate missing i18n translations using Cursor
i18n:translate:
  stage: test
  variables:
    MODEL: auto
    BRANCH_PREFIX: "translate"
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\\[i18n-skip\\]/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_REF_NAME !~ /^translate\// &&'
  script:
    # 1) Detect missing keys vs EN
    - node scripts/check-missing-i18n.js
    - |
      if [ ! -f i18n-missing.json ]; then
        echo "No missing translation keys detected. Skipping generation.";
        exit 0;
      fi
    # 2) Install Cursor CLI
    - curl https://cursor.com/install -fsS | bash
    - export PATH="$HOME/.local/bin:$HOME/.cursor/bin:$PATH"
    # 3) Configure Git identity
    - git config user.name "Cursor Agent"
    - git config user.email "cursoragent@cursor.com"
    # 3a) If a bot token is provided, set authenticated remote for pushes
    - |
      if [ -n "$BOT_GITLAB_TOKEN" ]; then
        git remote set-url origin "https://oauth2:${BOT_GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git";
        echo "Configured authenticated remote for bot pushes.";
      fi
    # 4) Prepare persistent translate branch
    - export TRANSLATE_BRANCH="${BRANCH_PREFIX}/${CI_COMMIT_REF_NAME}"
    - |
      git fetch origin --prune || true
      if git ls-remote --exit-code --heads origin "$TRANSLATE_BRANCH" >/dev/null 2>&1; then
        echo "Translate branch exists: $TRANSLATE_BRANCH";
        git checkout -B "$TRANSLATE_BRANCH" "origin/$TRANSLATE_BRANCH" || git checkout -B "$TRANSLATE_BRANCH";
        git merge --no-edit "origin/${CI_COMMIT_REF_NAME}" || true;
      else
        echo "Creating translate branch: $TRANSLATE_BRANCH";
        git checkout -B "$TRANSLATE_BRANCH" "origin/${CI_COMMIT_REF_NAME}" || git checkout -B "$TRANSLATE_BRANCH";
      fi
    # 5) Ask Cursor to fill only missing keys based on i18n-missing.json
    - |
      # Support GitLab "File"-type variables: if CURSOR_API_KEY points to a file, read its contents
      if [ -n "$CURSOR_API_KEY" ] && [ -f "$CURSOR_API_KEY" ]; then
        export CURSOR_API_KEY="$(cat "$CURSOR_API_KEY")"
      fi
      if [ -z "$CURSOR_API_KEY" ]; then
        echo "CURSOR_API_KEY is not set. Failing."; exit 1; fi
      # Executing agent command
      cursor-agent -p "You are operating in a GitLab CI runner with git available.

      # Context:
      - Project URL: ${CI_PROJECT_URL}
      - Project Path: ${CI_PROJECT_PATH}
      - MR IID: ${CI_MERGE_REQUEST_IID}
      - Source Branch: ${CI_COMMIT_REF_NAME}
      - Translate Branch: ${TRANSLATE_BRANCH}
      - Missing Keys Report: i18n-missing.json

      # Goal:
      - Read i18n-missing.json and add only the missing keys for each non-English locale under public/locales. Use the English values in public/locales/en as the source of truth and translate them to the target locale language. Never modify existing keys/values.

      # Requirements:
      1) For each locale listed in i18n-missing.json, open the corresponding JSON files and insert only the keys that are missing (create files if absent), preserving JSON structure and formatting.
      2) Do not overwrite or alter any existing translations or keys.
      3) Validate JSON formatting. Keep ordering stable where possible.
      4) Stage and commit changes to the currently checked-out translate branch with a concise commit message like: 'chore(i18n): add missing <locale> keys [i18n-skip]'. Do NOT push or call any remote APIs; leave pushing to the shell script that runs after you finish.
      5) If there are no changes to make, do nothing.

      # GitLab API:
      - Use ${GITLAB_TOKEN} (Personal Access Token with api scope) if needed to call: POST ${CI_SERVER_URL}/api/v4/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes
      - Compare link to include in the note: ${CI_PROJECT_URL}/-/compare/${CI_COMMIT_REF_NAME}...${TRANSLATE_BRANCH}
      " --force --model "$MODEL" --output-format=text
    # 6) Guard: ensure only public/locales/ changed compared to source branch, then push
    - |
      BASE_REF="origin/${CI_COMMIT_REF_NAME}"
      git fetch origin --prune || true
      CHANGED=$(git diff --name-only "$BASE_REF"...HEAD || true)
      echo "$CHANGED" | sed 's/^/changed: /'
      if echo "$CHANGED" | grep -v '^public/locales/' | grep -q .; then
        echo "Aborting: changes outside public/locales/ detected.";
        git reset --hard "$BASE_REF";
        exit 3;
      fi
      # Rebase on remote translate branch if it exists to avoid non-fast-forward
      if git ls-remote --exit-code --heads origin "$TRANSLATE_BRANCH" >/dev/null 2>&1; then
        git rebase "origin/$TRANSLATE_BRANCH" || true
      fi
      git push --force-with-lease origin "$TRANSLATE_BRANCH:$TRANSLATE_BRANCH" || true
      echo "Compare changes: ${CI_PROJECT_URL}/-/compare/${CI_COMMIT_REF_NAME}...${TRANSLATE_BRANCH}"
      # 7) Also apply the locales-only changes to the MR source branch and push
    - |
      git checkout "${CI_COMMIT_REF_NAME}"
      git fetch origin --prune || true
      git reset --hard "origin/${CI_COMMIT_REF_NAME}"
      # Merge translate branch; on conflict, abort and skip pushing to source
      git merge --no-ff -m "[i18n-skip]" "$TRANSLATE_BRANCH" \
        || (echo "Merge conflict when merging $TRANSLATE_BRANCH into ${CI_COMMIT_REF_NAME}; skipping push to source." && git merge --abort && exit 0)
      CHANGED_SRC=$(git diff --name-only "origin/${CI_COMMIT_REF_NAME}"...HEAD || true)
      echo "$CHANGED_SRC" | sed 's/^/src-changed: /'
      if echo "$CHANGED_SRC" | grep -v '^public/locales/' | grep -q .; then
        echo "Aborting push to source: changes outside public/locales/ detected.";
        git reset --hard "origin/${CI_COMMIT_REF_NAME}";
      else
        PUSHED_TO_SOURCE=0
        if git push origin "${CI_COMMIT_REF_NAME}"; then
          PUSHED_TO_SOURCE=1
          echo "Pushed locales changes to source branch: ${CI_COMMIT_REF_NAME}"
        else
          echo "Push to source branch failed (permissions or race)."
        fi
        # If the source push succeeded, clean up the intermediary translate branch locally and remotely
        if [ "$PUSHED_TO_SOURCE" -eq 1 ]; then
          git push origin --delete "$TRANSLATE_BRANCH" || true
          git branch -D "$TRANSLATE_BRANCH" || true
          echo "Cleaned intermediary branch: $TRANSLATE_BRANCH"
        fi
      fi
  dependencies: []

build:
  stage: build
  script:
    - pnpm run build
  artifacts:
    paths:
      - out/
    expire_in: 1 hour
  only:
    - main

pages:
  stage: deploy
  script:
    - cp -r out/* public/
  artifacts:
    paths:
      - public
    expire_in: never
  only:
    - main
  # Ensure public access
  environment:
    name: production
    url: $CI_PAGES_URL